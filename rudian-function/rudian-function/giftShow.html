<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" id="viewport">
	<title>作品预览</title>
	<!-- swiper 默认样式表 -->
  	<link rel="stylesheet" href="css/swiper.min.css" />
  	<!-- 定义页面元素 动画 -->
  	<link rel="stylesheet" href="css/animate.min.css" />
  	<style>
		/*css reset*/
		html, body, div, span, h1, h2, h3, h4, h5, h6, p, a, img, dl, dt, dd, ol, ul, li, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, footer, header, nav, section {
  			margin: 0;
  			padding: 0;
		}
		html, body, .swiper-container, .swiper-wrapper, .page, .content, .bg {
		    width: 100%;
		    height: 100%;
		}
		.content {
		  position: relative;
		}
		.bg{
			background-origin: content-box;
		    background-size: cover;
		    background-position: 50% 50%;
		}
		.main img {
		  position: absolute;
		  -webkit-user-select: none;
		  -moz-user-select: none;
		  -ms-user-select: none;
		  -o-user-select: none;
		  user-select: none;
		}
		.main p {
		  position: absolute;
		  -webkit-user-select: none;
		  -moz-user-select: none;
		  -ms-user-select: none;
		  -o-user-select: none;
		  user-select: none;
		}
		/*PC预览样式控制*/
		.bjsc{
			display: none;
			position: absolute;
			top:0;
			bottom:0;
			left:0;
			right: 0;
			background: url(images/tcbg.png) no-repeat center;
			background-size:cover;
		}
		.bjsc .gnyk{
			position: absolute;
			margin:auto;
			top:0;
			bottom:0;
			left:0;
			right:0;
			width: 60%;
			height: 60%;
		}
		.bjsc .gnykz{
			float: left;
			width:60%;
			height: 100%;
		}
		.bjsc .pjs{
			width:255px;
			height: 526px;
			background: url(images/yl/ylsj.png) 0px 0px no-repeat;
		}
		.bjsc .lran{
			width: 255px;
			height: 40px;
			margin-top: 20px;
			text-align: center;
			line-height: 40px;
			position: relative;
			left: 50%;
			margin-left: -127.5px;
		}
		.bjsc .lran span{
			display: inline-block;
			width:70px;
			height: 40px;
		}
		.bjsc .anl{
			background: url(images/yl/anlr.png) 0px 0px no-repeat;
		}
		.bjsc .anl:hover{
			background: url(images/yl/anlr.png) 0px -88px no-repeat;
		}
		.bjsc .anr{
			background: url(images/yl/anlr.png) 0px -44px no-repeat;
		}
		.bjsc .anr:hover{
			background: url(images/yl/anlr.png) 0px -132px no-repeat;
		}

		.bjsc .gnyky{
			width:40%;
			height: 100%;
		    float: left;
		}
		.bjsc .gnyky>div{
			position: relative;
			left: 50%;
			margin-left: -100px;
		}
		.bjsc .kys{
			width:200px;
			height: 100px;
			margin-top: 40px;
			border-bottom: 2px solid #ffffff;
			text-align: center;
		}
		.bjsc .kys span{
			display: block;
		}
		.bjsc .ciho{
			font-size: 24px;
			color:#ffffff;
		}
		.bjsc .naich{
			margin-top: 14px;
			font-size: 14px;
			color:#ffffff;
		}
		.bjsc .kyz{
			width:200px;
			height: 200px;
			margin-top: 20px;
			background: white;
			opacity: 0.8;
		}
		.bjsc .ssfx{
			width: 200px;
			height: 12px;
			text-align: center;
			line-height: 12px;
			margin-top: 5px;
		}
		.bjsc .ssfx span{
			font-size: 12px;
			color:#ffffff;
		}
		.bjsc .kyx{
			width: 201px;
			height: 45px;
			margin-top: 20px;
			border-bottom: 2px solid #ffffff;
		}
		.bjsc .kyx span{
			display: inline-block;
			width: 25px;
			height: 25px;
			margin-right:6px;
		}
		.bjsc .kyx span a{
			width: 100%;
			height: 100%;
			display: block;
		}
		.bjsc .kyx .k{
			background: url(images/page4/fenxiang.png) 0px 0px no-repeat;
		}
		.bjsc .kyx .q{
			background: url(images/page4/fenxiang.png) -35px 0px no-repeat;
		}
		.bjsc .kyx .w{
			background: url(images/page4/fenxiang.png) -70px 0px no-repeat;
		}
		.bjsc .kyx .f{
			background: url(images/page4/fenxiang.png) -105px 0px no-repeat;
		}
		.bjsc .kyx .p{
			background: url(images/page4/fenxiang.png) -140px 0px no-repeat;
		}
		.bjsc .kyx .x{
			margin-right: 0;
			background: url(images/page4/fenxiang.png) -175px 0px no-repeat;
		}
		.bjsc .wzz{
			width: 200px;
			height: 14px;
			text-align: center;
			line-height: 14px;
			margin-top: 20px;
		}
		.bjsc .wzz span{
			font-size: 14px;
			color: #ffffff;
		}
		.bjsc .wzz span a{
			text-decoration: underline;
			color: #2eb3e8;
		}
		.bjsc .pjs{
			width:349px;
			height: 720px;
			background: url(images/yl/ylsj.png) 0px 0px no-repeat;
			background-size: cover;
			position: relative;
			left: 50%;
			margin-left: -174.5px;
		}
		#giftPreview{
			width: 320px;
			height: 540px;
			position: absolute;
			left:50%;
			top: 50%;
			margin-left: -160px;
			margin-top: -270px;
			background-color: #fff;
		}
		.bjsc .main {
		  position: absolute;
		  top: 50%;
		  left: 50%;
		  margin-left: -320px;
		  margin-top: -504px;
		  width: 640px;
		  height: 1008px;
		  overflow: hidden;
		  transform: scale(0.5);
		}
		/* end */
		/*phone预览样式控制*/
		#giftPreview_phone{
			display: none;
			width: 100%;
			height: 100%;
			position: absolute;
			left: 0;
			top: 0;
			background-color: #fff;
		}
		#giftPreview_phone .main{
		  position: absolute;
		    top: 50%;
		    left: 50%;
		    margin-left: -320px;
		    margin-top: -504px;
		    width: 640px;
		    height: 1008px;
		    overflow: hidden;
		}
		/*end*/
		/*公共样式*/
		@keyframes next{
			0% {transform: translateY(0) rotate(-90deg);}
			50% {transform: translateY(-30px) rotate(-90deg);}
			100% {transform: translateY(0px) rotate(-90deg);}
		}
		#audio{
		  width: 40px;
		  height: 40px;
		  position: absolute;
		  top: 20px;
		  right: 20px;
		  border-radius: 50%;
		  z-index: 1000;
		  background:#fff url(images/zz/bjyyfh.png) no-repeat center;
		  animation: rota 10s linear infinite;
		}
		@keyframes rota{
			0% {transform: rotate(0deg);}
			50% {transform: rotate(180deg);}
			100% {transform: rotate(360deg);}
		}
		#giftPreview .swiper-button-next,#giftPreview_phone .swiper-button-next{
			position: absolute;
			top: 98%;
			left: 50%;
			margin-left: -13px;
			animation: next 3s linear infinite;
			opacity: 0.6;
		}
		/*end*/
  	</style>
</head>
<body>
	<!-- PC预览 -->
	<div class="bjsc">
	    <div class="gnyk">
	      <div class="gnykz">
	        <div class="pjs">
	          	<div id="giftPreview">
	            
	          	</div>
	        </div>
	        <div class="lran">
	          	<span class="anl"></span>
	          	<span class="anr"></span>
	        </div>
	      </div>
	      <div class="gnyky">
	        <div class="kys">
	          	<span class="ciho">吃货</span>
	          	<span class="naich">每天早晨一杯奶茶，心情都是<br/>美美哒</span>
	        </div>
	        <div class="kyz" id="qrcode"></div>
	        <div class="ssfx"><span>扫一扫，分享给朋友</span></div>
	        <div class="kyx">
	          	<span class="k"><a href=""></a></span>
	          	<span class="q"><a href=""></a></span>
	          	<span class="w"><a href=""></a></span>
	          	<span class="f"><a href=""></a></span>
	          	<span class="p"><a href=""></a></span>
	          	<span class="x"><a href=""></a></span>
	        </div>
	        <div class="wzz">
	          	<span>这么漂亮的场景→</span>
	          	<span><a href="login.html">我也要制作</a></span>
	        </div>
	      </div>
	    </div>
	</div>
	<!-- end -->
	<!-- Phone预览 -->
	<div id="giftPreview_phone"></div>
	<!-- end -->
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script src="js/jquery.qrcode.js"></script>
	<script src="js/qrcode.js"></script>
	<script src="js/aes.js"></script>
	<script src="js/md5.js"></script>
	<script src="js/mode-ecb.js"></script>
	<script src="js/pad-pkcs7.js"></script>
	<!-- swiper库 -->
	<script src="js/swiper.min.js"></script>
	<!-- swiper动画自动播放库 -->
	<script src="js/swiper.animate.min.js"></script>
	<!-- 控制swiper及动画启动 -->
	<script src="js/swipercontrol.js"></script>
	<script>
	/*设置meta:vp*/
	function setScale() {
		if (window.top !== window) {
			return;
		}
		var pageScale = 1;
		var width = document.documentElement.clientWidth || 640;
		var height = document.documentElement.clientHeight || 1008;
		if (width / height >= 640 / 1008) {
			pageScale = height / 1008;
		} else {
			pageScale = width / 640;
		}
		var content = 'width=640, initial-scale=' + pageScale + ', maximum-scale=' + pageScale + ', user-scalable=no';
		document.getElementById('viewport').setAttribute('content', content);
	}
	function dataDeal(returnCode, returnMsg, category,isPhone) {
	  	switch (category) {
	      	// 获取单个作品 并且预览
	    	case "gift_preview":
	      		console.log(returnMsg);
		    	var obj01 = returnMsg.gift;
		      	$(".ciho").text(obj01.giftname);
		      	var obj02 = returnMsg.giftPages;
		      	var obj03 = returnMsg.giftPageElements;
		      	// 创建 container wrapper  外层容器
		      	var container = $('<div class="swiper-container"></div>');
		      	var wrapper = $('<div class="swiper-wrapper"></div>');
		      	// 创建 页面动画js代码
		      	var pageJs = "var swiperAnimateParam_main1 = {";
		      	// 循环遍历创建 slide page content 三层容器 以及 bg main 背景容器和内容容器
		      	for (var i = 0; i < obj02.length; i++) {
		        	var slide = $('<div class="swiper-slide"></div>');
		        	var page = $('<div class="page"></div>');
		        	var content = $('<div class="content"></div>');
		        	var bg = $('<div class="bg"></div>');
		        	var main = $('<div class="main"></div>');
		        	var pageHtml = '';
		        	pageJs += "slide_" + (i + 1) + ":{";
		        	for (var j = 0; j < obj03.length; j++) {
		          		if (obj02[i].id == obj03[j].giftpageid) {
		            	var n = j;
		            	if (n < 10 && n > 0) {
		              		n = '0' + n;
		            	} else if (n == 0) {
		              		n = '01';
		            	}
		            	// 渲染动画JS
		            	if (obj03[j].animation.length) {
		            		for(var a = 0;a<obj03[j].animation.length;a++){
		            			pageJs += 'animate_' + n +':{element:"main1_ani_' + n + '",animation:"' + obj03[j].animation[a].animation + '",duration:"' + obj03[j].animation[a].duration + 's",delay:"' + obj03[j].animation[a].delay + 's"},';
		            		}
		              	}
		              	// 文本渲染
		            	if (obj03[j].eletype == 296) {
		              		var width = obj03[j].width + 'px';
			              	var pleft = obj03[j].left + 'px';
			              	var ptop = obj03[j].top + 'px';
			              	var zIndex = obj03[j].zindex;
			              	var fonts = obj03[j].fontsize + "px";
			              	var color = obj03[j].color;
			              	var fontw = obj03[j].fontweight;
		              		pageHtml += '<p class="main1_ani_' + n + '" style="width:' + width + ';top:' + ptop + ';left:' + pleft + ';z-index:' + zIndex + ';font-size:' + fonts + ';color:' + color + ';font-weight:' + fontw + ';">' + obj03[j].path + '</p>';
		            	} else {
		            	// 背景渲染
		              		if (obj03[j].isbg == 1) {
		                		bg.css('background-image','url("http://106.3.37.173:81/image/' + obj03[j].path + '")');
		                // 图片渲染
		              		} else if (obj03[j].eletype == 62) {
		                		var width = obj03[j].width + 'px';
		                		var pleft = obj03[j].left - obj03[j].width / 2 + 'px';
		                		var ptop = obj03[j].top - obj03[j].height / 2 + 'px';
		                		var zIndex = obj03[j].zindex;
		                		pageHtml += '<img class="main1_ani_' + n + '" src="http://106.3.37.173:81/image/' + obj03[j].path + '" style="width:' + width + ';top:' + ptop + ';left:' + pleft + ';z-index:' + zIndex + ';"/>';
		              		}
		            	}
		          	}
		        }
			        pageJs += '},';
			        main.append(pageHtml);
			        content.append(bg);
			        content.append(main);
			        page.append(content);
			        slide.append(page);
			        wrapper.append(slide);
			        container.append(wrapper);
		    	}
		    	// 判断PC端还是移动端
		      	if (isPhone) {
		      		var target = $('#giftPreview_phone');
		      		$('#giftPreview_phone').show();
		      		setScale();
		      	}else{
		      		var target = $('#giftPreview');
		      		$('.bjsc').show();
		      	}
		      	$(target).prepend(container);
		      	$('<div class="swiper-button-next"></div>').appendTo($(target));
		      	pageJs += '};';
		      	var js = document.createElement('script');
		      	js.text = pageJs;
		      	document.body.appendChild(js);
		      	// 生成并插入二维码
		      	$('#qrcode').qrcode({width: 200,height: 200,text: window.location.href});
		      	// 启动swiper及动画
		      	callback();
		      	// 背景音乐渲染
		      	if (obj01.mpath != null) {
		        	$('<div><audio src="' + obj01.mpath + '" loop="loop"></audio><span id="audio"></span></div>').appendTo(target);
		        	$('audio')[0].play();
		        	$('#audio').on('click', function(e) {
		          	e.stopPropagation;
		          	if ($('audio')[0].paused) {
		            	$('audio')[0].play();
		            	$('#audio').css('animation','rota 10s linear infinite');
		          	} else {
		            	$('audio')[0].pause();
		            	$('#audio').css('animation','none');
		          	}
		        });
		      }
	      /*end*/
	    	break;
	  	}
	}
	// 数据解密------------------------
	function getData(packets, interName, methName, category,isPhone) {
	  var token = "0FB451072D3FB25E3D5AE438D64FF3D7";
	  var key = CryptoJS.enc.Utf8.parse(token.slice(0, 16));
	  var data = CryptoJS.enc.Utf8.parse(JSON.stringify(packets));
	  var packetsAES = CryptoJS.AES.encrypt(data, key, {
	    mode: CryptoJS.mode.ECB,
	    padding: CryptoJS.pad.Pkcs7
	  }).toString();
	  var sign = "[" + [packetsAES, token].sort().toString().replace(",", ", ") + "]";
	  var signMD5 = CryptoJS.MD5(sign).toString();
	  $.ajax({
	    url: 'http://106.3.37.173:8080/love/' + interName,
	    // url: 'http://192.168.1.9:8080/love/' + interName,
	    type: 'get',
	    dataType: 'json',
	    data: {
	      'op': methName,
	      'packets': packetsAES,
	      'sign': signMD5
	    },
	    success: function(res) {
	      var returnCode = res.returnCode;
	      var returnMsg = res.returnMsg;
	      if (returnCode === "000") {
	        returnMsg = CryptoJS.AES.decrypt(returnMsg, key, {
	          mode: CryptoJS.mode.ECB,
	          padding: CryptoJS.pad.Pkcs7
	        });
	        /* ***1021 */
	        try {
	          returnMsg = JSON.parse(returnMsg.toString(CryptoJS.enc.Utf8));
	        } catch (err) {
	          returnMsg = returnMsg.toString(CryptoJS.enc.Utf8);
	        }
	      }
	      if (typeof dataDeal === "function") {
	        dataDeal(returnCode, returnMsg, category,isPhone);
	      } else {
	        console.log("dataDeal is not defined");
	      }
	    }
	  });
	}
	</script>
	<script>
	 // 获取设备信息
	 var device = window.navigator.appVersion.match(/(Android)|(iPhone)/);
	 if (device != null) {
	 	var isPhone = true;
	 }else{
	 	var isPhone = false;
	 }
	 // 获取作品ID 展示作品
	 var gift_id = window.location.href.match(/gift_id=(\d+)/g).join('').split('=')[1];
	 	getData({
	    "gid": gift_id,
	  }, 'giftsService.do', 'getGiftDetail', 'gift_preview',isPhone);
	</script>
</body>
</html>